<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Vibe Searching</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="vibe-container">
    <!-- Schritt 1: Stimmung auswählen -->
    <div *ngIf="currentStep === 1" class="question-container" [class.fade-out]="isAnimating">
      <h2>Welchen Vibe soll dein Film haben?</h2>
      
      <div class="button-container">
        <ion-button expand="block" (click)="selectMood('happy')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="happy-outline"></ion-icon>
            <span>Fröhlich</span>
          </div>
        </ion-button>
        
        <ion-button expand="block" (click)="selectMood('relaxed')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="leaf-outline" size="large"></ion-icon>
            <span>Entspannt</span>
          </div>
        </ion-button>
        
        <ion-button expand="block" (click)="selectMood('thrilling')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="flash-outline" size="large"></ion-icon>
            <span>Spannend</span>
          </div>
        </ion-button>

        <ion-button expand="block" (click)="selectMood('horror')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="skull-outline" size="large"></ion-icon>
            <span>Horror</span>
          </div>
        </ion-button>
        
        <ion-button expand="block" (click)="selectMood('action')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="flame-outline" size="large"></ion-icon>
            <span>Action</span>
          </div>
        </ion-button>
        
        <ion-button expand="block" (click)="selectMood('love')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="heart-outline" size="large"></ion-icon>
            <span>Romantik</span>
          </div>
        </ion-button>
        
        <ion-button expand="block" (click)="selectMood('music')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="musical-notes-outline" size="large"></ion-icon>
            <span>Musik</span>
          </div>
        </ion-button>

        <ion-button expand="block" (click)="selectMood('documentary')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="school-outline" size="large"></ion-icon>
            <span>Dokumentation</span>
          </div>
        </ion-button>
      </div>
    </div>
    
    <!-- Schritt 2: Filmdauer auswählen -->
    <div *ngIf="currentStep === 2" class="question-container" [class.fade-in]="!isAnimating">
      <h2>Wie lang darf der Film sein?</h2>
      
      <div class="button-container">
        <ion-button expand="block"  (click)="selectDuration('shortfilm')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="stopwatch-outline" size="large"></ion-icon>
            <div>Kurzfilm (<40 Min)</div>
          </div>
        </ion-button>
        
        <ion-button expand="block"  (click)="selectDuration('short')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="hourglass-outline" size="large"></ion-icon>
            <div>Kurz (40-90 Min)</div>
          </div>
        </ion-button>
        
        <ion-button expand="block"  (click)="selectDuration('normal')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="time-outline" size="large"></ion-icon>
            <div>Normal (90-120 Min)</div>
          </div>
        </ion-button>
        
        <ion-button expand="block"  (click)="selectDuration('extended')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="calendar-outline" size="large"></ion-icon>
            <div>Überlänge (>120 Min)</div>
          </div>
        </ion-button>
        
        <ion-button expand="block"  (click)="selectDuration('any')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="infinite-outline" size="large"></ion-icon>
            <div>Egal</div>
          </div>
        </ion-button>
      </div>
    </div>
    
    <!-- Schritt 3: Zeitrahmen auswählen -->
    <div *ngIf="currentStep === 3" class="question-container" [class.fade-in]="!isAnimating">
      <h2>Wie alt darf der Film sein?</h2>
      
      <div class="button-container">
        <ion-button expand="block"  (click)="selectTimeframe('new')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="calendar-outline" size="large"></ion-icon>
            <div>Neu</div>
          </div>
        </ion-button>
        
        <ion-button expand="block"  (click)="selectTimeframe('classic')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="time-outline" size="large"></ion-icon>
            <div>Klassiker</div>
          </div>
        </ion-button>
        
        <ion-button expand="block"  (click)="selectTimeframe('any')" class="vibe-button">
          <div class="button-content">
            <ion-icon name="infinite-outline" size="large"></ion-icon>
            <div>Egal</div>
          </div>
        </ion-button>
      </div>
    </div>
    
    <!-- Schritt 4: Ergebnisse anzeigen -->
    <div *ngIf="currentStep === 4" class="results-container" [class.fade-in]="!isAnimating">
      <h2>Deine Film-Empfehlungen</h2>
      
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6" size-lg="4" *ngFor="let movie of results; let i = index">
            <ion-card class="movie-card" #card [class.fading]="movie.fading">
              <img [src]="movie.poster_path ? 'https://image.tmdb.org/t/p/w300' + movie.poster_path : 'assets/images/movie-placeholder.jpg'" 
                   alt="{{movie.title}}"/>
              <ion-card-header>
                <ion-card-title>{{movie.title}}</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <div class="movie-info-row">
                  <p class="year">{{ movie.release_date | date:'yyyy' }}</p>
                  <div class="rating" *ngIf="movie.vote_average">
                    <ion-icon name="heart-outline"></ion-icon>
                    <span>{{ movie.vote_average | number:'1.1-1' }}</span>
                  </div>
                </div>
                
                <!-- Aktion: Favorit + Schon gesehen -->
                <div class="action-row">
                  <div class="action-buttons">
                    <!-- Schon gesehen -->
                    <ion-button fill="clear" size="small" (click)="onMarkWatched(movie, $event)"
                      aria-label="Als gesehen markieren">
                      <ng-container *ngIf="watchedIdSet.has(movie.id); else notWatched">
                        <ion-icon name="eye" slot="icon-only" color="success"></ion-icon>
                      </ng-container>
                      <ng-template #notWatched>
                        <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                      </ng-template>
                    </ion-button>
                     
                    <!-- Favorit -->
                    <ion-button fill="clear" size="small" (click)="onToggleFavorite(movie, $event)"
                      aria-label="Favorit umschalten">
                      <ng-container *ngIf="favoriteIdSet.has(movie.id); else notFavorite">
                        <ion-icon name="star" slot="icon-only" color="warning"></ion-icon>
                      </ng-container>
                      <ng-template #notFavorite>
                        <ion-icon name="star-outline" slot="icon-only"></ion-icon>
                      </ng-template>
                    </ion-button>
                  </div>
                </div>

                <!-- Provider-Section -->
                <div class="provider-section" *ngIf="movie.id">
                  <small class="provider-title">Watch on:</small>
                  <div class="provider-logos" *ngIf="movie.providers">
                    <img *ngFor="let provider of movie.providers"
                        [src]="'https://image.tmdb.org/t/p/original' + provider.logo_path" 
                        [alt]="provider.provider_name"
                        class="provider-logo" 
                        [title]="provider.provider_name">
                  </div>
                  <div *ngIf="movie.providersLoading" class="loading-providers">
                    <ion-spinner name="dots" size="small"></ion-spinner>
                  </div>
                  <small *ngIf="movie.providers?.length === 0 && !movie.providersLoading">
                    No streaming options found
                  </small>
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
      
      <!-- Abstand für die sticky Buttons -->
      <div class="sticky-button-spacer"></div>
    </div>

    <!-- Sticky Button Container -->
    <div class="sticky-button-container" *ngIf="currentStep === 4">
      <ion-button expand="block" (click)="restart()" class="sticky-button">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Neue Suche starten
      </ion-button>
      <ion-button expand="block" (click)="reshuffleMovies()" class="sticky-button">
        <ion-icon name="dice" slot="start"></ion-icon>
        Neue Filme shuffeln
      </ion-button>
    </div>
  </div>
</ion-content>

<style>
/* Sticky Button Container */
.sticky-button-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top, var(--ion-background-color) 80%, transparent);
  padding: 16px;
  padding-top: 30px;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Styling für die sticky Buttons */
.sticky-button {
  margin: 0;
}

/* Spacer am Ende der Ergebnisse, damit nichts vom sticky footer verdeckt wird */
.sticky-button-spacer {
  height: 120px; /* Höhe des sticky Bereichs plus etwas Abstand */
}

/* Anpassung der results-container */
.results-container {
  padding-bottom: 20px;
}
</style>
